## 시스템 간의 비동기 처리에 대한 처리 방법

### 1. API 통신

가장 간단한 방식으로 API 통신을 통해 처리하는 방식이다.   
이 경우는 API를 제공한 서비스가 데이터를 처리한다.
그래서 API를 제공한 서비스(데이터를 처리해야하는 곳)에서 멱등성을 처리해야줘야 한다.

```md
예를 들어 A 서비스가 B 서비스를 호출했을 때 timeout이나 504 에러로 인해 응답을 에러로 받는 상황이 발생할 수 있다.  
이 경우 A 서비스는 실패로 처리하지만, 실제로는 B 서비스에서 처리가 완료되어 데이터 정합성에 문제가 생길 수 있다.  
A 서비스가 재시도 방식을 쓰게 되면, 멱등성 처리가 되어 있지 않다면 동일한 데이터가 중복 처리될 위험이 있다.
```

또한 A 서비스가 실제로 에러를 받았을 경우 보상 트랜잭션도 고려해봐야한다.

### 2. 메시징 큐 처리

kafka나 RabbitMQ 같은 메시징 시스템을 이용해 전달한다.   
하지만 메시지 유실, 메시지 소비 순서, 트랜잭션에 대한 고민이 추가적으로 필요하다.  
데이터 전달 방법에 따라 방식이 달라질 수 있다.   

**메시지 큐에서도 데이터 전달 방법이 3가지가 있는데**
1. 최대 한번
   - producer, consumer가 메시지를 한번만 받거나 준다.
   - 메시지가 유실될 가능성이 크다.
   - 하지만 메시지 처리 속도가 가장 빠르다.
2. 최소 한번
   - producer는 메시지의 상태를 보고 여러번 전달할 수 있다.
   - consumer는 최소 한번 더 받는다 (ack가 되지않았을 경우)
   - consumer에서는 멱등성 처리를 해줘야한다.
3. 정확히 한번
   - producer, consumer 모두의 상태를 본다.
   - 누락과 중복은 없지만 그만큼 속도가 느리고 개발의 난이도가 올라간다.

전달 방식은 어떤 데이터를 가져오냐에 따라 달라질 수 있다.

메시지 유실에 대한 방식은 dead letter queue나 outbox 패턴을 추가로 대응할 수도 있다.


### 3. 데이터베이스를 메시징 큐처럼 사용하기

위에서 말한 outbox 패턴을 적용하는 경우이다.   
A 서비스에서 이벤트나 데이터를 저장하고 B 서비스가 폴링하여 메시지를 처리하는 방식이다.

트랜잭션 관리가 쉬운 편이라 데이터의 일관성을 보장할 수 있다.
하지만 대량의 데이터를 처리하기엔 부적합하다. (하나씩 처리하기 때문)
