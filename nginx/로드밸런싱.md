## Nginxë¡œ ë¡œë“œë°¸ëŸ°ì‹± êµ¬í˜„

### 1. nginx ì„¤ì •íŒŒì¼ ì°¾ê¸°(nginx.conf)

í•„ìëŠ” Ubuntuë¥¼ ì‚¬ìš©í•˜ê³  ìˆì–´ ê·¸ ê¸°ì¤€ìœ¼ë¡œ ì ë„ë¡ í•˜ê² ë‹¤. 

> /etc/nginx/nginx.conf

### 2. ë¡œë“œë°¸ëŸ°ì‹± ì„¤ì • íŒŒì¼ ì¶”ê°€

```
http {
	include /etc/nginx/site-enabled/*;
}
```
- í•„ìëŠ” ì´ëŸ°ì‹ìœ¼ë¡œ httpë‹¨ì—ì„œ includeë¡œ íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ ì„¤ì •ì„ í•˜ê²Œ ë˜ì–´ìˆë‹¤.
- ê·¸ë˜ì„œ site-enabled í´ë” ì•ˆì— ìƒˆë¡œìš´ íŒŒì¼ì„ ë§Œë“¤ì–´ ì¶”ê°€í•´ì£¼ë„ë¡ í•œë‹¤.

ì „ì²´ ê²½ë¡œ
> /etc/nginx/site-enabled/íŒŒì¼ ì´ë¦„

ğŸ‘¨â€ğŸ’» ì¶”ê°€í•  ë°ì´í„°

```js
upstream backend {  // backendìë¦¬ì— ì´ë¦„
    least_conn;     //ì•Œê³ ë¦¬ì¦˜ì„ ì ì–´ì¤€ë‹¤. (ê¸°ë³¸: ë¼ìš´ë“œ ë¡œë¹ˆ)
    server localhost:8801; 
    server localhost:8802; //í´ë¼ì´ì–¸íŠ¸ê°€ Nginxë¡œ ìš”ì²­ ì‹œ
    server localhost:8803; //ìš°íšŒì‹œì¼œì¤„ Server ì •ë³´
}

server {
  listen 80; //í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­í•˜ëŠ” í¬íŠ¸
  
  location / {
    proxy_set_header Host $host; //í´ë¼ì´ì–¸íŠ¸ì˜ í˜¸ìŠ¤íŠ¸ ì„¤ì •
    proxy_set_header Connection ""; //upstreamì„œë²„ë¥¼ ì‚¬ìš©í•˜ê² ë‹¤ ì§€ì •(â­ì¤‘ìš”)
    proxy_pass http://backend; //ì„¤ì •í•œ ì´ë¦„ìœ¼ë¡œ ìš”ì²­ ë³´ë‚´ê¸°
  }
}
```

- 80ë²ˆ í¬íŠ¸ì— ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ 8801~8803í¬íŠ¸(ì˜ˆì‹œ)ì— ì—´ë ¤ìˆëŠ” 3ê°œì˜ ì„œë²„ë¡œ ë¡œë“œë°¸ëŸ°ì‹±ì´ ì§„í–‰ëœë‹¤. 
- í•„ìëŠ” ìµœì†Œ ì—°ê²°ëœ ì„œë²„ë¥¼ ì°¾ì•„ ìš”ì²­ ë°›ëŠ” ë°©ì‹ì¸ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í–ˆë‹¤.
- ì´ì œ nginxë¥¼ ì¬ê°€ë™ ì‹œì¼œì£¼ë©´ ëœë‹¤.

> service nginx reload



### ğŸ”® ì•Œê³ ë¦¬ì¦˜ ì¢…ë¥˜

|ë°©ë²•|ì„¤ëª…|
|--|--|
|ë¼ìš´ë“œë¡œë¹ˆ(ê¸°ë³¸ê°’)|ìš”ì²­ì„ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬í•œë‹¤.|
|least_conn(ìµœì†Œ ì—°ê²°)|ê° ìš”ì²­ì„ ì„œë²„ì— í• ë‹¹ëœ ê°€ì¤‘ì¹˜ë¥¼ ê³ ë ¤í•´ ì—°ê²° ìˆ˜ê°€ ê°€ì¥ ì ì€ ì„œë²„ë¡œ ì „ì†¡|
|ip_hash|ìš”ì²­ì´ í´ë¼ì´ì–¸íŠ¸ IPì£¼ì†Œë¡œ í•´ì‹± > í•œë²ˆ ìš”ì²­ ë°›ì€ ì„œë²„ê°€ ìˆì„ ë•Œ í•´ë‹¹ ì„œë²„ì—ë§Œ ìš”ì²­ì„ ë¶„ë°°|
|least_time|ì—°ê²° ìˆ˜ê°€ ê°€ì¥ ì ìœ¼ë©´ì„œ í‰ê·  ì‘ë‹µì‹œê°„ì´ ê°€ì¥ ì ì€ ìª½ì„ ì„ íƒí•´ì„œ ë¶„ë°° (Nginx Plusì—ì„œë§Œ ê°€ëŠ¥)|


nginx.confì˜ íŒŒì¼ì„ ë°”ê¿”ì¤¬ì§€ë§Œ ë™ì‹œ íŠ¸ë˜í”½ì„ ê°ë‹¹í•˜ê¸° ìœ„í•´ì„œëŠ” ì—¬ëŸ¬ ìƒí™©ì„ ê³ ë ¤í•´ë´ì•¼í•œë‹¤.

## ë™ì‹œ ìš”ì²­ íŠ¸ë˜í”½ ê°ë‹¹


nginx ì„¤ì • ì´í›„ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³¸ ê²°ê³¼ **ë™ì‹œ ì ‘ì†ì ìˆ˜**ë¥¼ ëŠ˜ë ¤ë³´ë©´ ì—ëŸ¬ìœ¨ì´ ê½¤ ë†’ê²Œ ë°œìƒí•˜ì˜€ë‹¤...

í•„ìëŠ” ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ íˆ´ ì¤‘ì— **Apache Jmeter**ë¥¼ ì‚¬ìš©í–ˆë‹¤.
ì‚¬ìš©ë°©ë²•ì€ ë¸”ë¡œê·¸ì— ì •ë¦¬í•´ë‘ì—ˆìœ¼ë‹ˆ ë³´ê³  ì°¸ê³ í•´ë„ ì¢‹ë‹¤.
[JMeterì‚¬ìš©ë²•](https://velog.io/@kimjiwonpg98/JMETER-jmeter%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%B4-%EC%9B%B9%EC%84%9C%EB%B2%84-%EC%84%B1%EB%8A%A5%ED%85%8C%EC%8A%A4%ED%8A%B8%ED%95%98%EA%B8%B0)

ì´ ë¬¸ì œì ì€ Nginx ìì²´ ë¬¸ì œê°€ ì•„ë‹ˆë¼ í´ë¼ìš°ë“œ ì»´í“¨í„° ìŠ¤í™ ë¬¸ì œì´ê¸° ë•Œë¬¸ì— **ìì‹ ì˜ í´ë¼ìš°ë“œ ì»´í“¨í„° ìŠ¤í™ì— ëŒ€í•œ ì´í•´ì™€ ê°œë°œ í™˜ê²½ì— ëŒ€í•œ ì´í•´**ê°€ í•„ìš”í•˜ë‹¤.


> í•„ìì˜ ê°œë°œ í™˜ê²½
- CPU Core 2ê°œ, RAM 4G ì»´í“¨í„°ë¥¼ ì„œë²„ë¡œ ì‚¬ìš©
- DB: mariaDB
- API ê°œë°œ í™˜ê²½: Node.js


### Node.jsì—ì„œì˜ MariaDB ì„¤ì •

![mariaDB](https://images.velog.io/images/kimjiwonpg98/post/16ee06a2-f7ff-41ce-9e0a-b1a91242cc21/maria.png)

ì—¬ê¸°ì„œ **connectionLimit**ì´ ì¤‘ìš”í•˜ë‹¤!
í•´ë‹¹ ì„¤ì •ì€ MariaDBì—ì„œ **ë™ì‹œì— ì²˜ë¦¬í•˜ê³ ì í—ˆìš©í•˜ëŠ” ìš”ì²­ì˜ ê°œìˆ˜**ë¥¼ ëœ»í•œë‹¤.
ì‚¬ì§„ì—ëŠ” 300ì´ì§€ë§Œ í•„ìëŠ” 500ìœ¼ë¡œ ì •í•´ì£¼ì—ˆë‹¤.
ê·¸ë ‡ê²Œ ë˜ë©´ ë™ì‹œì— 500ê°œê¹Œì§€ Connectionì„ í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

#### ğŸ¤” Connection??
APIì„œë²„ì—ì„œ DBì— SQLì§ˆì˜ë¥¼ í•  ë•Œë§ˆë‹¤ ì—´ë¦¬ëŠ” ê²ƒì´ Connectionì´ë‹¤. 
SQLì§ˆì˜ë¥¼ í•  ë•Œ 1ê°œì”© ì‚¬ìš©ëœë‹¤.

ì´ë¥¼ ì´í•´í•˜ê¸° ìœ„í•´ì„œ Poolì´ë€ ê²ƒì„ ì´í•´í•´ì•¼í•œë‹¤.
Poolì€ Nodeì™€ MariaDBê°€ ì—°ê²°ë˜ëŠ” ë°©ì‹ì¸ë°
ì´ Poolì€ ê° Connectionì„ ë‹´ê³  ìˆëŠ” ê³µê°„ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤.

#### ğŸ‘·â€â™‚ï¸ ì£¼ì˜í•  ì 

```js
let conn;
try {
  conn = await mariadb.getConnection(); //pool connection
  const query = `SELECT * FROM persons`;
  
  const result = await conn.query(query);
  return result;
} catch (err) {
  throw err;
} finally {
  conn?.release(); // connection => pool
}
```

ì§ˆì˜ SQLë¬¸ì„ ë§Œë“ ë‹¤ë©´ ì´ë ‡ê²Œ ë§Œë“¤ê²Œ ë í…ë° poolì„ Connectioní–ˆë‹¤ë©´ ëë‚  ë•Œ release()ë¥¼ í•´ì¤˜ì•¼í•œë‹¤.

ë°˜í™˜ í•˜ì§€ ì•Šê²Œ ëœë‹¤ë©´ ì‚¬ìš©ê°€ëŠ¥í•œ Connectionì´ -1ê°œë¡œ ì¤„ì–´ë“¤ê²Œ ëœë‹¤. ê·¸ë˜ì„œ ëª¨ë“  SQL ì§ˆì˜ì—ì„œ release()ë¥¼ í•´ì¤˜ì•¼ í•œë‹¤.

#### Too many connections ì—ëŸ¬!

ê·¸ë¦¬ê³  Nginxì˜ ì„¤ì •ì´ mariadbë³´ë‹¤ ë†’ê²Œ ë˜ì–´ ìˆë‹¤ë©´ [Too many connections ì´ìŠˆ](https://velog.io/@kimjiwonpg98/mysql-too-many-connections-error-%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95)ë¥¼ ë³´ê³  ì„¤ì •ì„ ë°”ê¿”ë³´ì


### Nginx ì„¤ì •

- ë°ì´í„°ì˜ íë¦„
 client => Nginx => WAS(node.js) => DB (MySQL)
 
 Nodeì™€ MySQLì´ 500ê°œì˜ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í–ˆìœ¼ë‹ˆ ì•ë‹¨ì¸ Nginxì—ì„œë„ 500ê°œë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•´ì•¼í•œë‹¤.
 
 
 #### worker_connections ê°’ ë³€ê²½
 
 1. ì„¤ì • íŒŒì¼ ë“¤ì–´ê°€ê¸°
 
 > nano /etc/nginx/nginx.conf

2. worker_connections ê°’ ë³€ê²½

- event{...} ì§€ì‹œì ì•ˆì— ìˆë‹¤.
![](https://images.velog.io/images/kimjiwonpg98/post/dc3fec60-c4b6-43d4-a6b0-56f6043e18fc/image.png)


- worker_processes: core ëª¨ë“ˆ ì„¤ì •
  - ëª‡ ê°œì˜ ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ë¥¼ ìƒì„±í•  ê²ƒì¸ì§€ ì§€ì •í•˜ëŠ” ì§€ì‹œì–´    
  ğŸ•µï¸â€â™€ï¸ 1ì´ë©´ í•˜ë‚˜ì˜ ì½”ì–´ë§Œìœ¼ë¡œ ìš”ì²­ì„ ì²˜ë¦¬í•œë‹¤ëŠ” ëœ»
  - í•„ìëŠ” autoë¡œ ë‘ì—ˆë‹¤.
- worker_connections: Workerê°€ ì‹¤ì œë¡œ ì²˜ë¦¬í•  Connectionì˜ ê°¯ìˆ˜ì´ë‹¤.
- í•„ìëŠ” 1024ë¡œ í•˜ì˜€ë‹¤. => **Workerë‹¹ 1024ê°œì˜ ì—°ê²°ì„ ì²˜ë¦¬**í•˜ê² ë‹¤ëŠ” ì˜ë¯¸


âœ¨ ìµœëŒ€ ì ‘ì†ì ìˆ˜ = worker_processes * worker_connections

ì´ë ‡ê²Œ ë˜ë©´ ë™ì‹œ ìš”ì²­ì‹œ ë¬¸ì œì—†ì´ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ ëœë‹¤.


------

### ì°¸ê³  & ì¶œì²˜

- [ì´ë¯¸ì§€ ì¶œì²˜](https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=innolifes&logNo=222078920240) - ê°€ë¹„ì•„ naver posting
- [ì°¸ê³  ë¸”ë¡œê·¸](https://kamang-it.tistory.com/entry/WebServernginxnginx%EB%A1%9C-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-%ED%95%98%EA%B8%B0)
- [ê°™ì´ ì§„í–‰í•œ ë¶„ì˜ ë¸”ë¡œê·¸](https://blog.naver.com/dnfla420/222472899816)

