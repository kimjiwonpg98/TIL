# 이벤트 루프


1. 이벤트 루프는 기본적으로 자바스크립트 코드의 해석엔진인 v8 엔진의 단일쓰레드 방식을 비동기 처리가 가능하게 돕기 위해서 사용된다. 
이를 말하기 위해 v8엔진의 구조에 접근하며 설명해보겠다.

2. V8 엔진은 크게 두가지 영역으로 **메모리 힙**과 **콜스택 영역**이 존재합니다. 이벤트 루프의 설명을 위해 힙 영역 보다는 콜스택과 연결지어 말해보겠다.

3. 먼저 콜스택에는 기본적으로 원시값/객체 포인터/함수 프레임/메서드 등을 포함한 정적 데이터들이 담기는 곳이다. 

4. 이중에서도 함수프레임과 메서드에 초점을 맞추어 말해보겠다.

5. 자바스크립트 엔진이 코드 실행을 시작하면, 첫 줄 부터 차례대로 평가해가게 된다. 모든 코드는 동기적으로 평가되며, 동기 순서대로 콜스택에 차례로 쌓이게 됩니다. 

6. 이때 콜스택에는 함수 프레임과 메서드가 실행 단계적으로 쌓이게되며, 쌓인 코드들이 하나씩 후입 선출 구조로 실행되게 된다.

7. 문제는 비동기 코드에서 발생하는데 모든 코드가 동기적이라 했던 말은 일반적인 자바스크립트의 코드를 의미하며, 자바스크립트에는 비동기적으로 동작되는 특수한 몇 가지 API들이 존재한다. 

8. 이러한 비동기 코드를 수행시키기 위해 **이벤트루프가 필요**하게 됩니다.

9. 콜스택은 동기적으로 코드를 실행할 수 밖에 없는 구조다. 따라서, 비동기적인 동작을 처리하기 위해 V8 엔진은 자바스크립트 엔진 외에도 백그라운드와 콜백 큐, 그리고 이벤트 루프를 활용한다.

10. 여기서 백그라운드는 브라우저에서는 웹 API 단이다.

11. 자스 엔진은 코드를 해석하다가 비동기 코드. 예를 들어 setTimeout이나 Promise의 then을 만나면 해당 코드를 백그라운드단으로 넘기게 된다. 이때 콜스택은 백그라운드로 넘겨진 코드는 신경쓰지않고 동기적인 코드만 순차적으로 실행시켜나간다.

12. 백그라운드에서는 열심히 비동기 코드를 실행하고, 완료된 비동기 코드의 콜백 함수들을 차례로 콜백큐에 할당한다.

13. 큐는 기본적으로 선입선출로 동작한다. 따라서 완료된 비동기의 콜백함수들은 선입선출에 따라 실행되는데, 이때 사용되는게 이벤트 루프이다.

14. 이벤트 루프는 콜백큐를 검사하여 선입선출의 구조로 콜백함수를 선출하게되는데, 이때 선출된 콜백함수를 다시 콜스택에 쌓아넣는다. 이제서야 콜스택의 비동기의 콜백함수를 실행시키게되고, 결국 이러한 흐름으로 동기와 비동기 코드가 동작되게 된다.

15. 정리하자면, v8엔진은 비동기 코드를 처리하기 위해 이벤트루프라는 녀석을 활용하고, 이벤트 루프는 콜백큐에 담긴 콜백함수를 콜스택으로 넣어주는 역할을 한다는 것이다.

16. 그러나 주의할 점이 한가지 있다.

17. 바로 콜백큐의 선입선출에는 우선순위라는 예외조건이 있다. 우선순위는 콜백큐가 구성된 큐들의 우선적인 선출의 기준을 의미하며, 크게 두가지로 microtask queue, macro queue가 있다.

18. 기본적으로 마이크로태스크 큐의 우선순위가 가장 높으며, 프로미스의 댄이 여기에 할당된다. 따라서 프로미스의 비동기처리가 가장 빨리 동작하게 되는 것이며, setTimeout의 경우는 매크로 큐의 담겨 프로미스보다는 늦게 동작하게 된다.

19. 각 비동기 코드들에는 마이크로 혹은 태스크 혹은 그 등등의 큐들 중 어디에 삽입될 지가 정해져있으며, 그 엄격한 규정에 맞춰 큐에 할당된다.
이벤트 루프는 이러한 기준에 맞춰 콜백큐의 콜백함수를 콜스택에 할당해주게 되는 것이다.